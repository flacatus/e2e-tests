apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: deploy-konflux-ci
  labels:
    konflux-ci/kind: "true"
    app.kubernetes.io/version: "0.1"
  annotations:
    tekton.dev/pipelines.minVersion: "0.44.x"
    tekton.dev/tags: konflux
spec:
  description: |
    This task performs a full Konflux CI deployment. It clones the specified Git repository,
    checks out the desired branch, and runs deployment scripts using a kubeconfig retrieved from
    a Kubernetes secret. It is intended for use in OpenShift Pipelines or other Tekton environments.

  params:
    - name: cluster-access-secret
      description: Name of the Kubernetes Secret that contains the kubeconfig (base64 encoded) used to access the target cluster.
    - name: namespace
      description: Namespace where the above Secret is located.
    - name: repo-url
      description: URL of the Git repository containing the Konflux CI deployment scripts.
      default: https://github.com/konflux-ci/konflux-ci.git
    - name: repo-branch
      description: Git branch to check out when cloning the repository.
      default: main
    - name: create-test-resources
      description: Indicates if a set of test resources should be installed
      default: 'true'

  volumes:
    - name: workdir
      emptyDir: {}

  stepTemplate:
    env:
      - name: KUBECONFIG
        value: /var/workdir/.kube/config
    volumeMounts:
      - mountPath: /var/workdir
        name: workdir

  steps:
    - name: get-kubeconfig
      image: quay.io/konflux-ci/tekton-integration-catalog/utils:latest
      workingDir: /var/workdir
      script: |
        #!/bin/bash
        set -euo pipefail

        echo "[INFO] Retrieving kubeconfig from secret: $(params.cluster-access-secret) in namespace: $(params.namespace)"
        KUBECONFIG_B64=$(kubectl get secret "$(params.cluster-access-secret)" -n "$(params.namespace)" -o jsonpath='{.data.kubeconfig}' || true)

        if [[ -z "$KUBECONFIG_B64" ]]; then
          echo "[ERROR] Kubeconfig not found in secret $(params.cluster-access-secret) in namespace $(params.namespace)."
          exit 1
        fi

        mkdir -p /var/workdir/.kube
        echo "$KUBECONFIG_B64" | base64 -d > /var/workdir/.kube/config
        chmod 400 /var/workdir/.kube/config

        echo "[INFO] Verifying access to the target cluster..."
        kubectl cluster-info

    - name: e2e-test
      image: quay.io/redhat-user-workloads/konflux-qe-team-tenant/konflux-e2e/konflux-e2e-tests:on-pr-9866ba5deb66f71e4748de168257dcc7253b9d4c@sha256:7537d76f6d8efee963d46112f7948bb1a6777746343c25997e1718475d81fbd5
      command: ["/bin/sh"]
      args:
        - "-c"
        - |
          kubectl cluster-info

          exec /konflux-e2e/konflux-e2e.test \
            --ginkgo.label-filter=release-pipelines \
            --ginkgo.junit-report=foo/e2e-report.xml \
            --ginkgo.no-color \
            --ginkgo.vv \
            --ginkgo.timeout=2h
      securityContext:
        capabilities:
          add:
            - SETFCAP
      onError: continue
      env:
        - name: PYXIS_STAGE_KEY
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: pyxis-stage-key
        - name: PYXIS_STAGE_CERT
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: pyxis-stage-cert
        - name: SMEE_URL
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: smeeUrl
        - name: APP_WEBHOOK_SECRET
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: appWebhookSecret
        - name: APP_ID
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: appId
        - name: APP_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: appPrivateKey
        - name: GH_TOKEN
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: ghToken
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: ghToken
        - name: GH_ORG
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: ghOrg
        - name: QUAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: quayToken
        - name: QUAY_ORG
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: quayOrg
        - name: QUAY_DOCKERCONFIGJSON
          valueFrom:
            secretKeyRef:
              name: env-secrets
              key: quayDockerConfigJson
        - name: OFFLINE_TOKEN
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: stage_offline_token
        - name: KEYLOAK_URL
          value: "https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token"
        # Uncomment the following if you want to use a secret-provided Keycloak URL
        # - name: KEYLOAK_URL
        #   valueFrom:
        #     secretKeyRef:
        #       name: env-secrets
        #       key: stageKeyloakUrl
        - name: TOOLCHAIN_API_URL
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: stage_toolchain_api_url
        - name: ATLAS_STAGE_ACCOUNT
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: atlas-stage-account
        - name: ATLAS_STAGE_TOKEN
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: atlas-stage-token
        - name: ATLAS_AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: atlas-aws-access-key-id
        - name: ATLAS_AWS_ACCESS_SECRET
          valueFrom:
            secretKeyRef:
              name: konflux-e2e-secrets
              key: atlas-aws-secret-access-key
